{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white text-center">
        <h4>üîç V√©rifier l'Authenticit√© d'un Certificat</h4>
        <p class="mb-0">V√©rifiez un certificat √©mis par Certichain</p>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <h5>üìÑ V√©rifier par ID de Certificat</h5>
            <form id="verifyByIdForm">
              <div class="mb-3">
                <label for="certId" class="form-label">ID du Certificat</label>
                <input type="number" id="certId" name="cert_id" class="form-control" placeholder="ex: 123" required />
                <small class="form-text text-muted">L'ID est fourni lors de la cr√©ation du certificat</small>
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-success">üîç V√©rifier par ID</button>
              </div>
            </form>
          </div>
          <div class="col-md-4">
            <h5>‚õìÔ∏è V√©rifier par Hash Blockchain</h5>
            <form id="verifyByHashForm">
              <div class="mb-3">
                <label for="blockchainHash" class="form-label">Hash Blockchain</label>
                <input type="text" id="blockchainHash" name="blockchain_hash" class="form-control" placeholder="ex: 0x742d35Cc6634C053..." required />
                <small class="form-text text-muted">Le hash complet fourni lors de l'√©mission</small>
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-success">üîç V√©rifier par Hash</button>
              </div>
            </form>
          </div>
          <div class="col-md-4">
            <h5>üìé V√©rifier un Fichier Upload√©</h5>
            <form id="verifyByFileForm">
              <div class="mb-3">
                <label for="file" class="form-label">Uploader le fichier √† v√©rifier</label>
                <input type="file" id="file" name="file" class="form-control" accept=".pdf" required />
                <small class="form-text text-muted">Pour d√©tecter les modifications du PDF</small>
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-success">üîç V√©rifier le Fichier</button>
              </div>
            </form>
          </div>
        </div>
        <hr>
        <div id="result" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // V√©rification par ID de certificat
  document.getElementById("verifyByIdForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML = '<div class="alert alert-info">Recherche du certificat...</div>';

    const certId = document.getElementById("certId").value;
    fetch(`/api/certificates/public/${certId}`)
      .then(res => res.json())
      .then(data => {
        if (data.certificate) {
          const cert = data.certificate;
          resultDiv.innerHTML = `
            <div class="alert alert-success">
              ‚úÖ <strong>Certificat Trouv√©!</strong><br>
              <strong>Type:</strong> ${cert.certificate_type}<br>
              <strong>B√©n√©ficiaire:</strong> ${cert.recipient_name}<br>
              <strong>Domaine:</strong> ${cert.domain || 'N/A'}<br>
              <strong>√âmis le:</strong> ${new Date(cert.created_at).toLocaleDateString()}<br>
              <strong>Status Blockchain:</strong> ${cert.blockchain_hash ? '‚úÖ Enregistr√©' : '‚ùå Non enregistr√©'}<br>
              ${cert.blockchain_hash ? `<strong>Hash:</strong> ${cert.blockchain_hash.substring(0, 20)}...` : ''}
              ${cert.ipfs_hash ? `<br><a href="https://gateway.pinata.cloud/ipfs/${cert.ipfs_hash}" target="_blank" class="btn btn-sm btn-primary mt-2">Voir sur IPFS</a>` : ''}
              ${cert.file_hash ? `<a href="/certificate/${cert.id}/download" target="_blank" class="btn btn-sm btn-secondary mt-2 ms-2">T√©l√©charger PDF</a>` : ''}
            </div>
          `;
        } else {
          resultDiv.innerHTML = `<div class="alert alert-warning">‚ö†Ô∏è Certificat non trouv√© avec cet ID</div>`;
        }
      })
      .catch(err => {
        resultDiv.innerHTML = `<div class="alert alert-danger">Erreur: ${err.message}</div>`;
      });
  });

  // V√©rification par hash blockchain
  document.getElementById("verifyByHashForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML = '<div class="alert alert-info">V√©rification sur la blockchain...</div>';

    const blockchainHash = document.getElementById("blockchainHash").value;
    fetch("/verify-hash", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ blockchain_hash: blockchainHash })
    })
      .then(res => res.json())
      .then(data => {
        if (data.verified) {
          resultDiv.innerHTML = `
            <div class="alert alert-success">
              ‚úÖ <strong>Certificat Authentique!</strong><br>
              <strong>B√©n√©ficiaire:</strong> ${data.recipient}<br>
              <strong>Type:</strong> ${data.certificate_type || 'N/A'}<br>
              <strong>Domaine:</strong> ${data.domain || 'N/A'}<br>
              <strong>Date d'√©mission:</strong> ${new Date(data.issueDate * 1000).toLocaleDateString()}<br>
              <a href="https://gateway.pinata.cloud/ipfs/${data.ipfs}" target="_blank" class="btn btn-sm btn-primary mt-2">Voir le fichier sur IPFS</a>
            </div>
          `;
        } else {
          resultDiv.innerHTML = `<div class="alert alert-warning">‚ö†Ô∏è ${data.message || "Certificat non trouv√© sur la blockchain"}</div>`;
        }
      })
      .catch(err => {
        resultDiv.innerHTML = `<div class="alert alert-danger">Erreur: ${err.message}</div>`;
      });
  });

  // V√©rification par upload de fichier
  document.getElementById("verifyByFileForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML = '<div class="alert alert-info">Analyse du fichier et v√©rification sur la blockchain...</div>';

    const formData = new FormData(this);
    fetch("/verify", { method: "POST", body: formData })
      .then(res => res.json())
      .then(data => {
        if (data.verified) {
          resultDiv.innerHTML = `
            <div class="alert alert-success">
              ‚úÖ <strong>Fichier Authentique!</strong><br>
              <strong>B√©n√©ficiaire:</strong> ${data.recipient}<br>
              <strong>Date d'√©mission:</strong> ${new Date(data.issueDate * 1000).toLocaleDateString()}<br>
              <strong>Status:</strong> Fichier original non modifi√©<br>
              <a href="https://gateway.pinata.cloud/ipfs/${data.ipfs}" target="_blank" class="btn btn-sm btn-primary mt-2">Voir sur IPFS</a>
            </div>
          `;
        } else {
          resultDiv.innerHTML = `<div class="alert alert-danger">‚ùå <strong>Fichier Modifi√© ou Non Authentique!</strong><br>${data.message || "Ce fichier n'est pas enregistr√© sur la blockchain ou a √©t√© modifi√©."}</div>`;
        }
      })
      .catch(err => {
        resultDiv.innerHTML = `<div class="alert alert-danger">Erreur lors de l'analyse: ${err.message}</div>`;
      });
  });
</script>
{% endblock %}